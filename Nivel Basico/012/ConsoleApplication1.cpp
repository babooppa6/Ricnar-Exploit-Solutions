// ConsoleApplication1.cpp : Defines the entry point for the console application.
//

#include "stdafx.h"
#include <string.h>
#include <stdlib.h>
#include <stdio.h>
#include <windows.h>

void check(int* _cookie, int _cookie2);
FILE *f1;
HMODULE (*foo2)(LPCTSTR);

int main(int argc, char *argv[])
{
		void * buf2;
	    int cookie2 = 0;
		int cookie = 0;
		char buf[50];
		char * p_size;
		int * p_cookie;
		char size = 0;
		int leidos = 0;
		int maxsize = 50;
		foo2 = (HMODULE(*)(LPCTSTR))&LoadLibrary;

		/* Apertura del fichero original, para lectura en binario*/
		f1 = fopen("fichero.dat", "rb");
		if (f1 == NULL)
		{
			perror("No se puede abrir fichero.dat");
			return -1;
		}

		leidos = fread(&cookie, 1, 4, f1);
		leidos = fread(&cookie2, 1, 4, f1);
		leidos = fread(&size, 1, 1, f1);


		if (size > maxsize)
		{
			perror("Nos fuimos al carajo\n");
			return -1;


		}
		printf("cookie :%08x cookie2 :%08x size :%08x\n", cookie, cookie2, size);

		//__debugbreak();

		buf2 = malloc(50);
		p_cookie = &cookie;
		p_size = &size;
		
		
		check(p_cookie, cookie2);
		leidos = fread(&buf, 1, size, f1);
		memcpy(buf2, buf, 50);
		
		return 0;
	
}

	void check(int* _cookie, int _cookie2)
	{
		if (*_cookie + _cookie2 == 0x58552433) {
			foo2(TEXT("pepe.dll"));
		}
	
		return;

	}


   

